services:
  registry:
    image: registry:2
    container_name: forgejo-registry
    restart: always
    ports:
      - "5000:5000"
    volumes:
      - ./registry-data:/var/lib/registry
      - ./registry-htpasswd:/auth/htpasswd:ro
    environment:
      - REGISTRY_AUTH=htpasswd
      - REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm
      - REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd
    networks:
      - forgejo-net
    profiles:
      - registry

  forgejo:
    image: codeberg.org/forgejo/forgejo:${FORGEJO_VERSION:-14.0.1}
    container_name: forgejo
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO____APP_NAME=Forgejo
      - FORGEJO__database__DB_TYPE=sqlite3
      - FORGEJO__database__PATH=/data/gitea/gitea.db
      - FORGEJO__server__HTTP_PORT=3000
      - FORGEJO__server__SSH_PORT=22
      - FORGEJO__security__INSTALL_LOCK=true
      - FORGEJO__service__DISABLE_REGISTRATION=true
      - FORGEJO__service__REQUIRE_SIGNIN_VIEW=false
    restart: always
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - ./forgejo-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - forgejo-net

  tunnelmole:
    image: node:20-alpine
    container_name: forgejo-tunnelmole
    command: sh -c "apk add --no-cache socat && socat TCP-LISTEN:3000,fork,reuseaddr TCP:forgejo:3000 & npm install -g tunnelmole && tmole 3000"
    depends_on:
      - forgejo
    restart: always
    networks:
      - forgejo-net
    profiles:
      - tunnel

  hashserv:
    image: ubuntu:22.04
    container_name: yocto-hashserv
    command: sh -c "apt-get update && apt-get install -y python3 python3-pip git && pip3 install websockets && [ -d /bitbake ] || git clone --depth 1 https://git.openembedded.org/bitbake /bitbake && /bitbake/bin/bitbake-hashserv --bind wss://0.0.0.0:8686 --database /data/hashserver.db --log INFO --read-only"
    restart: always
    ports:
      - "8686:8686"
    volumes:
      - ./hashserv-data:/data
      - ./yocto-cache/sstate-cache:/sstate-cache:ro
    networks:
      - forgejo-net
    profiles:
      - hashserv

  sstate-server:
    image: docker.io/library/nginx:alpine
    container_name: yocto-sstate-server
    restart: always
    ports:
      - "8080:80"
    volumes:
      - ./yocto-cache/sstate-cache:/usr/share/nginx/html/sstate-cache:ro
      - ./yocto-cache/downloads:/usr/share/nginx/html/downloads:ro
      - ./nginx-sstate.conf:/etc/nginx/conf.d/default.conf:ro
      - ./sstate-htpasswd:/etc/nginx/.htpasswd:ro
    networks:
      - forgejo-net
    profiles:
      - sstate-server

networks:
  forgejo-net:
    driver: bridge
